# Сайт EyePoint

Больше информации

https://ximc.ru/issues/37198  
https://ximc.ru/issues/38120  
https://ximc.ru/issues/36703  

# Как развернуть
## Подготовка "чистой" машины
На "чистом" linux нужно поставить все необходимые программы. Это docker и git (последний - чтобы скачать код сайта):

```bash
sudo apt update
sudo apt install docker.io git
```

Затем скачать репозиторий с исходным кодом сайта:
```bash
git clone https://github.com/EPC-MSU/ep-website.git ~/epwebsite
cd ~/epwebsite/
```
(скачать можно в любую папку)

Теперь нужно создать Docker volume для страницы скачивания файлов. Делать это нужно так:
```bash
sudo docker volume create download
```

Чтобы наполнить диск файлами для скачивания, нужно узнать, где он распологается. Для этого посмотреть вывод команды
```bash
docker volume inspect download
```
Обратить внимание на строчку (ваш путь может быть другим):
```
"Mountpoint": "/var/lib/docker/volumes/download/_data",
```
именно по этому пути нужно располагать файлы для загрузки. 
Архитектура файлов должна быть следующая:
```
<имя продукта>
  |
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение> 
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
  |    | ...
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
<имя продукта>
  |
  ...
```
Например (файлы ниже располагаются в /var/lib/docker/volumes/download/_data):
```
EyePoint_P10
  |
  |--documentation
  |    |
  |    | - manual-0.0.0-d.pdf
  |    | - manual-0.0.1-d.pdf
  |    | - newman-1.1.5-h.txt
  |
  |--software
  |    |
  |    | - gui-5.5.0-win32.exe
  |    | - gui-5.5.0-deb.rpm
  |
EyePoint_S2
  |
  |--documentation
  |    |
  |    | - man-5.4.2-h.html
  |    | - man.2.2.2-y.pdf
  |
  |--driver
  |    |
  |    | - driver-0.0.0-win.inf
  |    | - driver-0.0.0-win.cat
  | 
```
Имена EyePoint_S2 взяты из полей name в файле data/products.
Система с файлами достаточно гибкая. Версии файлов желательны - но страница заработает и без них. Имена категорий софта 
(driver, documentation, software) и иконки желательно указать в data/download.py - но страница заработает и без этого.
Подробнее о том, как добавлять новые файлы и новые категории, смотри главу "Как модифицировать"

## Сборка и запуск сайта

Внутри папки с исходным кодом лежит Docker container. Теперь, когда есть docker volume с файлами, можно собрать и 
запустить контейнер: 
```bash
sudo docker build . -t epw
sudo docker run --publish 80:8080 --restart=always -d --mount source=download,target=/app/view/static/download epw
```

Для тестов, без Docker, сайт можно просто запустить:
```bash
python -m pip install -r requirements.txt
python server.py
```
Сайт тестировался на python3.7
При тестовом запуске папка view/static/download должна существовать

Для пересборки контейнера на сервере можно использовать скрипт:
```bash
bash scripts/rebuild-docker.sh
```
Он удалит существующий контейнер, соберёт новый и запустит

# Как модифицировать

## Как добавить\удалить новый продукт

Описание всех продуктов лежит в файле data/products.py. Новый продукт нужно создать по образцу, добавив имя, путь к 
картинке, описание и список технических характеристик.  
Катинка продукта должна лежать в папке view/static/images (см. примеры других продуктов)

После добавления продукта, а также после исправления любого текста, который видит пользователь (описание, 
вводная часть, - любое слово, любая буква в интерфейсе) нужно обновлять файлы переводов

## Как обновить файлы переводов

Для обновления переводов есть специальный скрипт scripts/update-po-files.sh
Его нужно запустить из папки с проектом, т.е. как-то так:
```bash
bash scripts/update-po-files.sh
```
При этом пакет gettext должен быть установлен, pygettext3 должен быть установлен.

Этот скрипт просмотрит код сайта, найдёт все места, которые нуждаются в переводе на английский, и добавит в файл
перевода эти места.
Текст перевода нужно написать самому. Для этого удобно использовать программу Poedit. С её помощью нужно открыть файл
locale/en_US/LC_MESSAGES/en.po и добавить отсутствующие переводы.  
Обрати внимание: если сервер развёрнут локально (не Docker), нужно ещё скомпилировать эти переводы. За это отвечает 
скрипт scripts/rebuild-locale.sh

## Как добавить новый файл для скачивания

Если, например, для EyePoint_P10 вышла новая прошивка, достаточно просто положить её в docker volume в папку 
EyePoint_P10/firmware. Сервер обновляет список файлов регулярно каждые 10 минут  

## Как добавить новую группу для скачивания

Пусть, например, для EyePoint P10 появился новый софт (помимо "прошивки" и "драйвера") - например, "плагины" (plugins)  
Тогда в папке EyePoint_P10 (имя папки - как в "name" продукта, см. файл data/products) нужно создать папку plugins и 
накидать туда файлы для скачивания. Имена файлов нужно давать по образцу файлов в других папках.  
Новая группа появится автоматически на сайте.  
Но чтоб у этой группы было красивое имя (а не просто "plugins", как имя папки), и чтобы у неё была своя иконка, нужно 
добавить новую категорию в список categories в файле data/download.py. Делать это нужно по образцу других категорий. 
После этого не забыть обновить файл перевода. 

# Прочее

Иконки флагов взяты с  
https://github.com/HatScripts/circle-flags.git  
Другие иконки взяты с  
https://www.iconsdb.com/white-icons/  
При добавлении новых иконок желательно брать из той же серии, чтобы хранить стиль.

За основу сайта взят бесплатный интернет-шаблон. Шаблон сильно переработан. Но в css\html всё ещё могут быть лишние 
фрагменты кода. 