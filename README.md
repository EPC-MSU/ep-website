# Сайт EyePoint

Это простой сайт с каталогом товаров и файлами для скачивания софта под каждый товар. Сайт предназначался для линейки 
товаров EyePoint, но может быть переделан (и переделывается) под другие продукты.

# Quick start

Проще всего поднять сайт с помощью [docker-compose](https://docs.docker.com/compose/).
На Linux:
* Распакуйте архив sample/download_volume.tar
* Папку download из архива поместите в view/static/
* Дальше соберите и запустие контейнер
```bash
sudo apt-get update
sudo apt-get install docker-compose
sudo docker-compose up
```
Сайт запустится на порту 8080. На порту 5000 поднимется sftp-сервер, на который нужно добавить файлы загрузки по 
инструкции "Добавление файлов загрузки". 

# Разворачивание сайта на сервере

Для разворачивания на серверах ЦИФ МГУ есть готовые конфигурации и инструкции в приватном репозитории 
https://github.com/EPC-MSU/server-config. Если ты из ЦИФ и разворачиваешь новый проект на наших серверах, читай 
инструкцию из репозитория выше.

Для полноценной работы сайта нужно добавить контент на страницу загрузки, см. инструкцию "Добавление файлов загрузки"

# Разработка сайта

Для разработки сайта удобно запустить его на ПК локально. Для этого:
* Распаковать тестовое наполнение страниц загрузки. Т.е. папку download из архива sample/download_volume.tar скопировать в 
  view/static/
* Скачать и установить python3.8
* Собрать файлы переводов 
```shell
bash scripts/rebuild-locale.sh
```
* Установить все необходимые пакеты и запустить:
```shell
python -m pip install -r requirements.txt
python server.py
```
Сайт появится на localhost:8080

Сайт можно разрабатывать и под windows. Для этого нужно дополнительно установить пакет [gettext](https://stackoverflow.com/questions/18985482/how-to-install-gnu-gettext-on-windows-7)

## Как добавить\удалить новый продукт на сайт

Описание всех продуктов лежит в файле data/products.py. Новый продукт нужно создать по образцу, добавив имя, путь к 
картинке, описание и список технических характеристик.  
Картинка продукта должна лежать в папке view/static/images (см. примеры других продуктов)

После добавления продукта, а также после исправления любого текста, который видит пользователь (описание, 
вводная часть, - любое слово, любая буква в интерфейсе) нужно обновлять файлы переводов

## Как обновить файлы переводов

Для обновления переводов есть специальный скрипт scripts/update-po-files.sh
Его нужно запустить из папки с проектом, т.е. как-то так:
```bash
bash scripts/update-po-files.sh
```
При этом пакет gettext должен быть установлен

Этот скрипт просмотрит код сайта, найдёт все места, которые нуждаются в переводе на английский, и добавит в файл
перевода эти места.
Текст перевода нужно написать самому. Для этого удобно использовать программу Poedit. С её помощью нужно открыть файл
locale/en_US/LC_MESSAGES/en.po и добавить отсутствующие переводы.  
Обрати внимание: если сервер развёрнут локально (не Docker), нужно ещё скомпилировать эти переводы. За это отвечает 
скрипт scripts/rebuild-locale.sh

## Как добавить новую группу для скачивания

Пусть, например, для EyePoint P10 появился новый софт (помимо "прошивки" и "драйвера") - например, "плагины" (plugins)  
Тогда в папке EyePoint_P10 (имя папки - как в "name" продукта, см. файл data/products) нужно создать папку plugins и 
накидать туда файлы для скачивания. Имена файлов нужно давать по образцу файлов в других папках.
Затем нужно добавить новую категорию в список categories в файле data/download.py. Делать это нужно по образцу других 
категорий. 
После этого не забыть обновить файл перевода. 

# Добавление файлов загрузки

К Docker volume со скачиваемыми файлами можно подключиться удалённо через ssh. Для этого есть специальный контейнер 
dockershare который разворачивает ssh сервер с доступом исключительно к Docker volume.  

Зайти по ssh (sftp, sshfs) можно вот так:
```bash
ssh -p 5000 root@<домен сайта> -i id_rsa
```
id_rsa - приватный ключ доступа. Публичный ключ доступа лежит в репозитории рядом с файлом контейнера в папке 
dockershare; приватный ключ должен быть у администратора. При обновлении ключей нужно заново сгенерировать пару 
приватный\публичный ключ, публичный ключ положить в папку с контейнером dockershare в репозиторий  

Содержимое docker volume отображается в папку /drive контейнера

Для работы с папкой удобно пользоваться командой sshfs. Пример её запуска:
```bash
sshfs -p 5000 -oIdentityFile=/home/walker/Job/keys/id_rsa root@eyepoint.kea.su:/drive /home/walker/foo
```
/home/walker/Job/keys/id_rsa - полный путь до приватного ключа
eyepoint.kea.su - доменное имя сайта (либо IP)
/home/walker/foo - путь, по которому хотите смонтировать удалённую папку. Точка монтирования должна существовать.

## Структура файлов загрузки

```
<имя продукта>
  |
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение> 
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
  |    | ...
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
<имя продукта>
  |
  ...
```
Например:
```
EyePoint_P10
  |
  |--documentation
  |    |
  |    | - manual-0.0.0-d.pdf
  |    | - manual-0.0.1-d.pdf
  |    | - newman-1.1.5-h.txt
  |
  |--software
  |    |
  |    | - gui-5.5.0-win32.exe
  |    | - gui-5.5.0-deb.rpm
  |
EyePoint_S2
  |
  |--documentation
  |    |
  |    | - man-5.4.2-h.html
  |    | - man.2.2.2-y.pdf
  |
  |--driver
  |    |
  |    | - driver-0.0.0-win.inf
  |    | - driver-0.0.0-win.cat
  | 
```
Система с файлами достаточно гибкая. Версии файлов желательны - но страница заработает и без них. Имена категорий софта 
(driver, documentation, software) и иконки желательно указать в data/download.py - но страница заработает и без этого.
Подробнее о том, как добавлять новые файлы и новые категории, смотри главу "Как модифицировать" на Wiki странице

# Прочее

### Бэкапы и перенос данных

На машине с наполненным volume с именем download и развёрнутым контейнером сайта, который должен быть назван epw,
делаем:
```bash
docker run --rm --volumes-from epw -v $(pwd):/backup busybox tar cvf /backup/backup.tar /app/view/static/download
```
Путь /app/view/static/download совпадает с путём при создании контейнера. В результате получается файл backup.tar.
Переместите файл backup.tar на другой хост, например через sshfs (установите sshfs: sudo apt install sshfs)
На другой системе положите файл backup.tar в текущую директорию и создайте контейнер для распаковки:
```bash
sudo docker create --mount source=download,destination=/app/view/static/download --name unpack busybox true
```
Далее далее запустите в этом контейнере распаковку, аналогично тому, как это было описано выше для архива с примером
данных (download_sample):
```bash
sudo docker run --rm --volumes-from unpack -v $(pwd):/backup busybox tar xvf /backup/backup.tar
docker container rm unpack
```

## Источники и дополнительная информация

Иконки флагов взяты с  
https://github.com/HatScripts/circle-flags.git  
Другие иконки взяты с  
https://www.iconsdb.com/white-icons/  
При добавлении новых иконок желательно брать из той же серии, чтобы хранить стиль.

За основу сайта взят бесплатный интернет-шаблон. Шаблон сильно переработан. Но в css\html всё ещё могут быть лишние 
фрагменты кода. 

### Больше информации

https://ximc.ru/issues/37198  
https://ximc.ru/issues/38120  
https://ximc.ru/issues/36703  
https://ximc.ru/issues/47312
