# Сайт EyePoint

Больше информации

https://ximc.ru/issues/37198  
https://ximc.ru/issues/38120  
https://ximc.ru/issues/36703  

# Как развернуть
## Подготовка "чистой" машины
На "чистом" linux нужно поставить все необходимые программы. Это docker и git (последний - чтобы скачать код сайта):

```bash
sudo apt update
sudo apt install docker.io git
```

Затем скачать репозиторий с исходным кодом сайта:
```bash
git clone https://github.com/EPC-MSU/ep-website.git ~/epwebsite
cd ~/epwebsite/
```
(скачать можно в любую папку)

## Сборка и запуск сайта

Теперь нужно создать Docker volume для страницы скачивания файлов. Образец volume можно развернуть из приложенного
архива: 
```bash
sudo docker create --mount source=download,destination=/app/view/static/download --name unpack busybox true
sudo docker run --rm --volumes-from unpack -v $(pwd)/sample:/backup busybox tar xvf /backup/download_volume.tar
```
А именно: мы создаём(находим, если ранее существовал) volume с именем download, контейнер с именем unpack для 
распаковки архива и указываем путь внутри нового контейнера /app/view/static/download, который будет использоваться 
и в основном контейнере. В приложенном архиве пути ведут именно туда - это важно.
Далее мы запускаем временный контейнер, который подключит volume download и указываем тот же путь внутри 
/app/view/static/download. Также внутрь мы передаём папку sample с download_volume.tar, который внутри будет называться 
/backup/download_volume.tar. Запускается распаковка архива и volume заполняется данными.   

После этого контейнер unpack можно удалить:
```bash
docker container rm unpack
```

Для проверки или ручной модификации файлов нужно узнать, где распологается volume. Для этого посмотрите вывод команды
```bash
docker volume inspect download
```
Обратить внимание на строчку (ваш путь может быть другим):
```
"Mountpoint": "/var/lib/docker/volumes/download/_data",
```
По этому пути должны были появиться файлы.

Для поддержки HTTPS нужно положить файлы сертификата   
fullchain.pem (сертификат)  
fullchain.pem (приватный ключ сертификата)  
в папку с проектом (там где Dockerfile). Без этих файлов рядом сайт будет работать без поддержки HTTPS  

Внутри папки с исходным кодом лежит Docker container. Теперь, когда есть docker volume с файлами, можно собрать и 
запустить контейнер: 
```bash
sudo docker build . -t epw
docker run --name epw --publish 80:8080 --publish 443:8443 --restart=always -d --mount source=download,target=/app/view/static/download epw
```

Для тестов, без Docker, сайт можно просто запустить:
```bash
python -m pip install -r requirements.txt
python server.py
```
Сайт тестировался на python3.7
При тестовом запуске папка view/static/download должна существовать

Для пересборки контейнера на сервере можно использовать скрипт:
```bash
bash scripts/rebuild-docker.sh
```
Он удалит существующий контейнер, соберёт новый и запустит

# Удалённый доступ

К Docker volume со скачиваемыми файлами можно подключиться удалённо через ssh. Для этого есть специальный контейнер 
dockershare который разворачивает ssh сервер с доступом исключительно к Docker volume.  
Скрипт для разворачивания\пересборки контейнера есть в папке scripts/rebuild-share.sh
```bash
bash scripts/rebuild-share.sh
```
После запуска этого скрипта на хосте появится (помимо контейнера с сайтом) контейнер для доступа к папке скачиваемых 
файлов по ssh    
Зайти по ssh (sftp, sshfs) можно вот так:
```bash
ssh -p 5022 root@<домен сайта> -i id_rsa
```
id_rsa - приватный ключ доступа. Публичный ключ доступа лежит в репозитории рядом с файлом контейнера в папке 
dockershare; приватный ключ должен быть у администратора. При обновлении ключей нужно заново сгенерировать пару 
приватный\публичный ключ, публичный ключ положить в папку с контейнером dockershare в репозиторий  

Содержимое docker volume отображается в папку /drive контейнера

Для работы с папкой удобно пользоваться командой sshfs. Пример её запуска:
```bash
sshfs -p 5022 -oIdentityFile=/home/walker/Job/keys/id_rsa root@eyepoint.kea.su:/drive /home/walker/foo
```
/home/walker/Job/keys/id_rsa - полный путь до приватного ключа
eyepoint.kea.su - доменное имя сайта (либо IP)
/home/walker/foo - путь, по которому хотите смонтировать удалённую папку. Точка монтирования должна существовать.

# Как модифицировать

## Как добавить\удалить новый продукт

Описание всех продуктов лежит в файле data/products.py. Новый продукт нужно создать по образцу, добавив имя, путь к 
картинке, описание и список технических характеристик.  
Катинка продукта должна лежать в папке view/static/images (см. примеры других продуктов)

После добавления продукта, а также после исправления любого текста, который видит пользователь (описание, 
вводная часть, - любое слово, любая буква в интерфейсе) нужно обновлять файлы переводов

## Как обновить файлы переводов

Для обновления переводов есть специальный скрипт scripts/update-po-files.sh
Его нужно запустить из папки с проектом, т.е. как-то так:
```bash
bash scripts/update-po-files.sh
```
При этом пакет gettext должен быть установлен, pygettext3 должен быть установлен.

Этот скрипт просмотрит код сайта, найдёт все места, которые нуждаются в переводе на английский, и добавит в файл
перевода эти места.
Текст перевода нужно написать самому. Для этого удобно использовать программу Poedit. С её помощью нужно открыть файл
locale/en_US/LC_MESSAGES/en.po и добавить отсутствующие переводы.  
Обрати внимание: если сервер развёрнут локально (не Docker), нужно ещё скомпилировать эти переводы. За это отвечает 
скрипт scripts/rebuild-locale.sh

## Как добавить новый файл для скачивания

Если, например, для EyePoint_P10 вышла новая прошивка, достаточно просто положить её в docker volume в папку 
EyePoint_P10/firmware. Сервер обновляет список файлов регулярно каждые 10 минут  

## Как добавить новую группу для скачивания

Пусть, например, для EyePoint P10 появился новый софт (помимо "прошивки" и "драйвера") - например, "плагины" (plugins)  
Тогда в папке EyePoint_P10 (имя папки - как в "name" продукта, см. файл data/products) нужно создать папку plugins и 
накидать туда файлы для скачивания. Имена файлов нужно давать по образцу файлов в других папках.  
Новая группа появится автоматически на сайте.  
Но чтоб у этой группы было красивое имя (а не просто "plugins", как имя папки), и чтобы у неё была своя иконка, нужно 
добавить новую категорию в список categories в файле data/download.py. Делать это нужно по образцу других категорий. 
После этого не забыть обновить файл перевода. 

# Прочее

## Управление volume download

### Ручное создание

Делать это нужно так:
```bash
sudo docker volume create download
```
Определите пути, расположения файлов, как в пункте выше. Архитектура файлов должна быть следующая:
```
<имя продукта>
  |
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение> 
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
  |    | ...
  |--<категория софта>
  |    |
  |    | - <имя файла в формате имя-версия.версия.версия-платформа.расширение>
<имя продукта>
  |
  ...
```
Например (файлы ниже располагаются в /var/lib/docker/volumes/download/_data):
```
EyePoint_P10
  |
  |--documentation
  |    |
  |    | - manual-0.0.0-d.pdf
  |    | - manual-0.0.1-d.pdf
  |    | - newman-1.1.5-h.txt
  |
  |--software
  |    |
  |    | - gui-5.5.0-win32.exe
  |    | - gui-5.5.0-deb.rpm
  |
EyePoint_S2
  |
  |--documentation
  |    |
  |    | - man-5.4.2-h.html
  |    | - man.2.2.2-y.pdf
  |
  |--driver
  |    |
  |    | - driver-0.0.0-win.inf
  |    | - driver-0.0.0-win.cat
  | 
```
Имена EyePoint_S2 взяты из полей name в файле data/products.
Система с файлами достаточно гибкая. Версии файлов желательны - но страница заработает и без них. Имена категорий софта 
(driver, documentation, software) и иконки желательно указать в data/download.py - но страница заработает и без этого.
Подробнее о том, как добавлять новые файлы и новые категории, смотри главу "Как модифицировать"

### Бэкапы и перенос данных

На машине с наполненным volume с именем download и развёрнутым контейнером сайта, который должен быть назван epw,
делаем:
```bash
docker run --rm --volumes-from epw -v $(pwd):/backup busybox tar cvf /backup/backup.tar /app/view/static/download
```
Путь /app/view/static/download совпадает с путём при создании контейнера. В результате получается файл backup.tar.
Переместите файл backup.tar на другой хост, например через sshfs (установите sshfs: sudo apt install sshfs)
На другой системе положите файл backup.tar в текущую директорию и создайте контейнер для распаковки:
```bash
sudo docker create --mount source=download,destination=/app/view/static/download --name unpack busybox true
```
Далее далее запустите в этом контейнере распаковку, аналогично тому, как это было описано выше для архива с примером
данных (download_sample):
```bash
sudo docker run --rm --volumes-from unpack -v $(pwd):/backup busybox tar xvf /backup/backup.tar
docker container rm unpack
```

## Источники и дополнительная информация

Иконки флагов взяты с  
https://github.com/HatScripts/circle-flags.git  
Другие иконки взяты с  
https://www.iconsdb.com/white-icons/  
При добавлении новых иконок желательно брать из той же серии, чтобы хранить стиль.

За основу сайта взят бесплатный интернет-шаблон. Шаблон сильно переработан. Но в css\html всё ещё могут быть лишние 
фрагменты кода. 